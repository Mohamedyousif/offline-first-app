<html>

<head>
  <script src="https://cdn.vaadin.com/vaadin-core-elements/latest/webcomponentsjs/webcomponents-lite.min.js"></script>
  <link rel="import"
      href="https://cdn.vaadin.com/vaadin-core-elements/latest/vaadin-grid/vaadin-grid.html">

  <style>
  #lazy {
    height: 300px;
  }
  </style>

  <script src="pouchdb-5.3.1.min.js"></script>

  <script>

  var selected = {};
  var grid;

  var remote_db = new PouchDB('http://localhost:5984/techlunch');

  (function() {
    HTMLImports.whenReady(function() {
      grid = document.querySelector('#lazy');

      grid.columns[0].renderer = function(cell) {
        cell.element.textContent = cell.row.index;
      };

      remote_db.allDocs().then(function(res) {
        var ids = res.rows;

        grid.items = function(params, callback) {

          var sub_ids=[];
          for(var i=params.index; i<params.count + params.index; i++) {
            sub_ids[i-params.index] = { id: ids[i].id, rev: ids[i].value.rev };
          }

          if(params.count > 0) {
          remote_db.bulkGet({ docs: sub_ids}).then(function(json) {

              var data = [];
              for(var i=0; i<json.results.length; i++) {
                data[i] = json.results[i].docs[0].ok;
              }

              callback(data, ids.length);
          });
          }else {
            callback(sub_ids, ids.length);
          }
        };
      });

      grid.addEventListener('selected-items-changed', function() {
        grid.selection.selected(function(idx) {
          grid.getItem(idx, (err, res) => selected = res);
          document.getElementById('fn').value = selected.firstName;
          document.getElementById('ln').value = selected.lastName;
          document.getElementById('em').value = selected.email;
        });
      });
    });
  })();

  var update = function() {
    selected.firstName = document.getElementById('fn').value;
    selected.lastName = document.getElementById('ln').value;
    selected.email = document.getElementById('em').value;
  }
  </script>

</head>

<body>
  <vaadin-grid id="lazy">
    <table>
      <colgroup>
        <col name="number" width="80">
        <col name="firstName">
        <col name="lastName">
        <col name="email">
      </colgroup>
      <thead>
      <tr>
        <th>#</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Email</th>
      </tr>
      </thead>
    </table>
  </vaadin-grid>

  <h3>Editor</h3>
  <table>
    <tr><td>First Name</td> <td><input type="text" id="fn" /></td></tr>
    <tr><td>Last Name</td>  <td><input type="text" id="ln" /></td></tr>
    <tr><td>Email</td>      <td><input type="text" id="em" /></td></tr>

    <tr><td><button onclick="update()">Update</button></td></tr>
  </table>
</body>

</html>
