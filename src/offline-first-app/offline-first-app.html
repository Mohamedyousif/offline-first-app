
<script src="../../bower_components/pouchdb/dist/pouchdb.min.js"></script>

<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="offline-first-app">
  <template>
    <style>
      :host {
        display: block;
      }

      #lazyGrid {
        height: 100%;
      }

      #gridArea {
        height: 100%;
      }
    </style>

    <div id="gridArea">
      <vaadin-grid id="lazyGrid"></vaadin-grid>
    </div>
  </template>

  <script>
    Polymer({

      is: 'offline-first-app',

      properties: {
        // Remote DB, running on a local instance of CouchDB.
        remoteDB: {
          type: PouchDB,
          value: new PouchDB('http://localhost:5984/personsdb'),
        },

        // Local DB, the synched version of `remoteDB`
        localDB: {
          type: PouchDB,
          value: new PouchDB('local_personsdb'),
        },

        allDocs: Array, // All docs in the grid.
      },

      ready: function() {

        PouchDB.replicate(this.remoteDB, this.localDB);

        var grid = this.$.lazyGrid;

        grid.columns = [
          { name: '#', width: 70},
          { name: 'firstName' },
          { name: 'lastName' },
          { name: 'email' },
        ];

        grid.columns[0].renderer = function(cell) {
          cell.element.textContent = cell.row.index;
        };

        this.localDB.allDocs().then(result => {
          this.allDocs = result.rows;

          grid.items = (params, callback) => {

            // Construct docs starting from current index,
            // and up to the requested length by Grid.
            var currentDocs = [];
            var currentIndex = params.index;
            for(var i=currentIndex; i<currentIndex+params.count; i++) {
              currentDocs[i-currentIndex] = {
                id: this.allDocs[i].id,
                rev: this.allDocs[i].value.rev,
              };
            }

            var data = [];
            if(currentDocs.length > 0) {
              this.localDB.bulkGet({
                  docs: currentDocs,
              }).then(json => {
                for(var i=0; i<json.results.length; i++) {
                  data[i] = json.results[i].docs[0].ok;
                }
                callback(data, this.allDocs.length);
              });
            }else {
              callback(data, this.allDocs.length);
            }
          }
        });
      },

    });
  </script>
</dom-module>
